name: End-to-End Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Nightly tests

env:
  REGISTRY_URL: localhost:5000
  TEST_TIMEOUT: 1800  # 30 minutes

jobs:
  setup-test-registry:
    runs-on: ubuntu-latest
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
    steps:
      - name: Verify registry
        run: curl -f http://localhost:5000/v2/ || exit 1

  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -r requirements.txt
          pip install -r tests/requirements-test.txt

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --cov=core --cov=commands

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3

  e2e-single-host:
    runs-on: ubuntu-latest
    needs: setup-test-registry
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Install robocore-cli
        run: |
          pip install -e .

      - name: Setup test environment
        run: |
          # Create test ROS packages
          mkdir -p test-project/packages/simple_publisher
          cp -r tests/e2e/fixtures/test-packages/simple_publisher/* test-project/packages/simple_publisher/

          # Create test config
          cp tests/e2e/configs/single-host.yaml test-project/config.yaml

      - name: Run single host test
        timeout-minutes: 15
        run: |
          cd test-project

          # Initialize project
          robocore-cli . init --non-interactive

          # Stage components
          robocore-cli . stage

          # Build components
          robocore-cli . build

          # Deploy (local)
          robocore-cli . deploy

          # Verify containers are running
          sleep 10
          docker ps | grep simple_publisher

      - name: Test ROS communication
        run: |
          # Check if ROS topics are being published
          timeout 30 docker exec $(docker ps -q --filter name=simple_publisher) \
            bash -c "source /opt/ros/humble/setup.bash && ros2 topic list | grep /test_topic"

  e2e-multi-host:
    runs-on: ubuntu-latest
    needs: setup-test-registry
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create multi-host network
        run: |
          # Create custom Docker network to simulate multi-host
          docker network create --driver bridge \
            --subnet=192.168.100.0/24 \
            robocore-test-net

      - name: Launch simulated hosts
        run: |
          # Launch containers that act as "hosts"
          docker run -d --name manager-host \
            --network robocore-test-net \
            --ip 192.168.100.10 \
            --privileged \
            -v /var/run/docker.sock:/var/run/docker.sock \
            docker:dind

          docker run -d --name worker1-host \
            --network robocore-test-net \
            --ip 192.168.100.11 \
            --privileged \
            -v /var/run/docker.sock:/var/run/docker.sock \
            docker:dind

          docker run -d --name worker2-host \
            --network robocore-test-net \
            --ip 192.168.100.12 \
            --privileged \
            -v /var/run/docker.sock:/var/run/docker.sock \
            docker:dind

      - name: Setup SSH access to simulated hosts
        run: |
          # Setup SSH keys and access for multi-host deployment
          ssh-keygen -t rsa -b 2048 -f ~/.ssh/test_key -N ""

          for host in manager-host worker1-host worker2-host; do
            # Install SSH and setup keys in each host
            docker exec $host sh -c "
              apk add --no-cache openssh-server openssh-client
              ssh-keygen -A
              echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config
              /usr/sbin/sshd
            "

            # Copy public key to host
            docker cp ~/.ssh/test_key.pub $host:/root/.ssh/authorized_keys
          done

      - name: Run multi-host deployment test
        timeout-minutes: 20
        run: |
          cd test-project

          # Use multi-host config
          cp ../tests/e2e/configs/multi-host.yaml config.yaml

          # Update config with actual container IPs
          sed -i 's/192.168.56.10/192.168.100.10/g' config.yaml
          sed -i 's/192.168.56.11/192.168.100.11/g' config.yaml
          sed -i 's/192.168.56.12/192.168.100.12/g' config.yaml

          # Deploy to multiple hosts
          robocore-cli . stage
          robocore-cli . build
          robocore-cli . deploy

          # Verify deployment across hosts
          sleep 15

          # Check containers are running on different hosts
          docker exec manager-host docker ps | grep dds_router
          docker exec worker1-host docker ps | grep publisher
          docker exec worker2-host docker ps | grep subscriber

      - name: Test DDS discovery and communication
        run: |
          # Test ROS communication between hosts
          timeout 60 docker exec worker2-host \
            docker exec $(docker ps -q --filter name=subscriber) \
            bash -c "
              source /opt/ros/humble/setup.bash && \
              timeout 30 ros2 topic echo /test_topic --once
            "

      - name: Cleanup
        if: always()
        run: |
          docker stop manager-host worker1-host worker2-host || true
          docker rm manager-host worker1-host worker2-host || true
          docker network rm robocore-test-net || true

  e2e-cross-arch:
    runs-on: ubuntu-latest
    needs: setup-test-registry
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test cross-architecture build
        timeout-minutes: 25
        run: |
          cd test-project

          # Use cross-arch config
          cp ../tests/e2e/configs/cross-arch.yaml config.yaml

          # Build for multiple architectures
          robocore-cli . stage
          robocore-cli . build

          # Verify images for both architectures exist
          docker image inspect localhost:5000/test_robot_amd64_node:latest
          docker image inspect localhost:5000/test_robot_arm64_node:latest

  performance-benchmarks:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'  # Only run on nightly builds
    needs: setup-test-registry
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000

    steps:
      - uses: actions/checkout@v4

      - name: Install performance monitoring tools
        run: |
          sudo apt-get update
          sudo apt-get install -y time sysstat

      - name: Run performance benchmarks
        run: |
          # Benchmark build times with different component counts
          for components in 1 3 5 10; do
            echo "Testing with $components components"

            # Generate test config with N components
            python tests/performance/generate_test_config.py --components=$components

            # Time the build process
            /usr/bin/time -v robocore-cli test-project stage 2>&1 | tee "benchmark_stage_${components}comp.log"
            /usr/bin/time -v robocore-cli test-project build 2>&1 | tee "benchmark_build_${components}comp.log"
          done

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: performance-benchmarks
          path: benchmark_*.log

  integration-with-real-ros:
    runs-on: ubuntu-latest
    needs: setup-test-registry
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000

    steps:
      - uses: actions/checkout@v4

      - name: Setup ROS 2 Humble
        run: |
          sudo apt update
          sudo apt install -y curl gnupg lsb-release

          curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null

          sudo apt update
          sudo apt install -y ros-humble-desktop

      - name: Test with real ROS packages
        run: |
          source /opt/ros/humble/setup.bash

          # Create project with real ROS packages
          mkdir -p test-real-ros/packages
          cd test-real-ros/packages

          # Create a simple ROS package
          ros2 pkg create --build-type ament_python test_real_package

          # Add some basic functionality
          cat > test_real_package/test_real_package/publisher.py << 'EOF'
          import rclpy
          from rclpy.node import Node
          from std_msgs.msg import String

          class TestPublisher(Node):
              def __init__(self):
                  super().__init__('test_publisher')
                  self.publisher_ = self.create_publisher(String, 'test_topic', 10)
                  self.timer = self.create_timer(1.0, self.timer_callback)

              def timer_callback(self):
                  msg = String()
                  msg.data = f'Hello from robocore-cli test {self.get_clock().now()}'
                  self.publisher_.publish(msg)
                  self.get_logger().info(f'Publishing: {msg.data}')

          def main():
              rclpy.init()
              node = TestPublisher()
              rclpy.spin(node)
              rclpy.shutdown()

          if __name__ == '__main__':
              main()
          EOF

          # Update setup.py to include the script
          cd ..

          # Create robocore config
          cat > config.yaml << 'EOF'
          ros_distro: humble
          ros_domain_id: 42
          registry: localhost:5000
          image_prefix: real_ros_test

          hosts:
            - name: localhost
              ip: 127.0.0.1
              user: runner
              arch: amd64
              manager: true

          components:
            - name: test_real_component
              source: packages/test_real_package
              runs_on: localhost
              entrypoint: ros2 run test_real_package publisher
          EOF

          # Test complete workflow
          robocore-cli . stage
          robocore-cli . build
          robocore-cli . deploy

          # Verify ROS communication
          sleep 10
          timeout 30 bash -c "
            source /opt/ros/humble/setup.bash && \
            ros2 topic echo /test_topic --once
          "