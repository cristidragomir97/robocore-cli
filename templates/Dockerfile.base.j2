# ─── STAGE 0: Build ROS2 + common_packages ───────────────────────────────
FROM ubuntu:{{ ubuntu }} AS common-builder

ENV DEBIAN_FRONTEND=noninteractive

# Configure apt to retry and handle mirror sync issues
RUN echo 'Acquire::Retries "3";' > /etc/apt/apt.conf.d/80-retries && \
    echo 'Acquire::http::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries && \
    echo 'Acquire::ftp::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries

{% if apt_mirror %}
# Configure custom Ubuntu apt mirror: {{ apt_mirror }}
RUN sed -i 's|http://archive.ubuntu.com/ubuntu|{{ apt_mirror }}|g' /etc/apt/sources.list && \
    sed -i 's|http://security.ubuntu.com/ubuntu|{{ apt_mirror }}|g' /etc/apt/sources.list && \
    sed -i 's|http://ports.ubuntu.com/ubuntu-ports|{{ apt_mirror }}|g' /etc/apt/sources.list
{% endif %}

RUN apt-get clean && rm -rf /var/lib/apt/lists/* && \
    apt-get update && apt-get install -y --fix-missing \
    locales \
    curl \
    gnupg2 \
    lsb-release \
    software-properties-common \
    git \
    net-tools \
    inetutils-ping \
    iproute2 && \
    locale-gen en_US.UTF-8 


ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Add ROS2 apt repository
{% if ros_apt_mirror %}
# Using custom ROS apt mirror: {{ ros_apt_mirror }}
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add - && \
    sh -c 'echo "deb [trusted=yes] [arch=$(dpkg --print-architecture)]  {{ ros_apt_mirror }} $(lsb_release -cs) main" > /etc/apt/sources.list.d/ros2-latest.list'
{% else %}
# Using default ROS apt mirror (packages.ros.org)
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add - && \
    sh -c 'echo "deb [arch=$(dpkg --print-architecture)] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" > /etc/apt/sources.list.d/ros2-latest.list'
{% endif %}

# Install ROS2 base + build tools
RUN apt-get clean && apt-get update && apt-get install -y --fix-missing \
    ros-{{ ros_distro }}-ros-base \
    python3-colcon-common-extensions \
    python3-rosdep \
    python3-pip && \
    pip3 install {% if ubuntu == 'noble' %}--break-system-packages {% endif %}-U vcstool && \
    rosdep init



# Overlay your shared packages
WORKDIR /ros_ws_common

{% set has_vcs = common_pkgs | selectattr('is_vcs_based') | list | length > 0 %}
{% set has_local = common_pkgs | selectattr('is_local_based') | list | length > 0 %}
{% set has_any_packages = has_vcs or has_local %}

{% if has_any_packages %}
# Create src directory
RUN mkdir -p src

# VCS-based packages: generate repos.yaml and import with vcstool
{% if has_vcs %}
COPY <<EOF /tmp/repos.yaml
repositories:
{% for pkg in common_pkgs %}
{% if pkg.is_vcs_based %}
{% for repo in pkg.repositories %}
  {{ repo.folder }}:
    type: git
    url: {{ repo.url }}
    version: {{ repo.version }}
{% endfor %}
{% endif %}
{% endfor %}
EOF

RUN vcs import src < /tmp/repos.yaml
{% endif %}

# Local source-based packages: copy directly
{% for pkg in common_pkgs %}
{% if pkg.is_local_based %}
{% for src_path in pkg.source %}
COPY {{ src_path }} /ros_ws_common/src/
{% endfor %}
{% endif %}
{% endfor %}

# Install dependencies with rosdep
RUN rosdep update && \
    . /opt/ros/{{ ros_distro }}/setup.sh && \
    rosdep install --from-paths src --ignore-src -r -y

# Build all packages
RUN . /opt/ros/{{ ros_distro }}/setup.sh && colcon build --symlink-install --install-base install

{% endif %}


# automatically source ROS2 and common overlay
RUN echo "source /opt/ros/{{ ros_distro }}/setup.bash" >> ~/.bashrc
{% if has_any_packages %}
RUN echo "source /ros_ws_common/install/setup.bash" >> ~/.bashrc
{% endif %}

ENTRYPOINT ["/bin/bash","-lc","exec \"$@\"","--"]
CMD ["bash"]
