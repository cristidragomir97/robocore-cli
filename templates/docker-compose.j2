version: '3.8'
services:
{% for comp in components %}
  {{ comp.name }}:
    image: {{ comp.image }}
    restart: unless-stopped

    # bindâ€mount the full workspace
    volumes:
      - "{{ mount_root }}/{{ comp.name }}/ros_ws:/ros_ws:ro"

    environment:
      - ROS_DOMAIN_ID={{ ros_domain_id }}
      - ROS_DISTRO={{ ros_distro }}

{% if comp.devices %}
    # device mappings
    devices:
{% for d in comp.devices %}
      - "{{ d }}"
{% endfor %}
    # automatically grant required capabilities
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
{% endif %}

{% if comp.ports %}
    # port forwards
    ports:
{% for p in comp.ports %}
      - "{{ p }}"
{% endfor %}
{% endif %}

    # the actual ROS2 launch command
    command: > 
      bash -lc "\
        source /opt/ros/{{ ros_distro }}/setup.bash && \
        source /ros_ws/install/setup.bash && \
        {{ comp.entrypoint }} {{ comp.launch_args | default('') }} \
      "
{% endfor %}
